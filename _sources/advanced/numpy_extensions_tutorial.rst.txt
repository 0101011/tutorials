

.. _sphx_glr_advanced_numpy_extensions_tutorial.py:


Creating extensions using numpy and scipy
=========================================
**Author**: `Adam Paszke <https://github.com/apaszke>`_

In this tutorial, we shall go through two tasks:

1. Create a neural network layer with no parameters.

    -  This calls into **numpy** as part of it’s implementation

2. Create a neural network layer that has learnable weights

    -  This calls into **SciPy** as part of it’s implementation



.. code-block:: python


    import torch
    from torch.autograd import Function
    from torch.autograd import Variable







Parameter-less example
----------------------

This layer doesn’t particularly do anything useful or mathematically
correct.

It is aptly named BadFFTFunction

**Layer Implementation**



.. code-block:: python


    from numpy.fft import rfft2, irfft2


    class BadFFTFunction(Function):

        def forward(self, input):
            numpy_input = input.numpy()
            result = abs(rfft2(numpy_input))
            return torch.FloatTensor(result)

        def backward(self, grad_output):
            numpy_go = grad_output.numpy()
            result = irfft2(numpy_go)
            return torch.FloatTensor(result)

    # since this layer does not have any parameters, we can
    # simply declare this as a function, rather than as an nn.Module class


    def incorrect_fft(input):
        return BadFFTFunction()(input)







**Example usage of the created layer:**



.. code-block:: python


    input = Variable(torch.randn(8, 8), requires_grad=True)
    result = incorrect_fft(input)
    print(result.data)
    result.backward(torch.randn(result.size()))
    print(input.grad)





.. rst-class:: sphx-glr-script-out

 Out::

    11.0598  10.8397   7.7748   1.3809   8.2040
      3.6309  15.7710   6.0033   6.1237   7.4903
      8.9816   3.0133   4.0838  10.3010   1.0924
      7.9300   7.1046  11.5952   2.7757  16.4836
      7.1614  11.9024  14.3691   6.2482   3.2664
      7.9300   8.8192   3.6235   9.1872  16.4836
      8.9816  16.4221   6.5526  21.0738   1.0924
      3.6309   4.3839   3.1680   8.4162   7.4903
    [torch.FloatTensor of size 8x5]

    Variable containing:
    -0.0200 -0.0138 -0.0517  0.0011 -0.2626  0.0011 -0.0517 -0.0138
     0.3066 -0.0273 -0.0768  0.1633  0.1029  0.0119 -0.0341 -0.0286
     0.2402  0.1999 -0.0514  0.0524 -0.0317 -0.0548  0.0258 -0.0027
     0.1350 -0.0304 -0.1659 -0.0730 -0.0405 -0.0207  0.0513  0.2066
     0.1267  0.2289 -0.0425 -0.1210 -0.2992 -0.1210 -0.0425  0.2289
     0.1350  0.2066  0.0513 -0.0207 -0.0405 -0.0730 -0.1659 -0.0304
     0.2402 -0.0027  0.0258 -0.0548 -0.0317  0.0524 -0.0514  0.1999
     0.3066 -0.0286 -0.0341  0.0119  0.1029  0.1633 -0.0768 -0.0273
    [torch.FloatTensor of size 8x8]


Parametrized example
--------------------

This implements a layer with learnable weights.

It implements the Cross-correlation with a learnable kernel.

In deep learning literature, it’s confusingly referred to as
Convolution.

The backward computes the gradients wrt the input and gradients wrt the
filter.

**Implementation:**

*Please Note that the implementation serves as an illustration, and we
did not verify it’s correctness*



.. code-block:: python


    from scipy.signal import convolve2d, correlate2d
    from torch.nn.modules.module import Module
    from torch.nn.parameter import Parameter


    class ScipyConv2dFunction(Function):
        @staticmethod
        def forward(ctx, input, filter):
            result = correlate2d(input.numpy(), filter.numpy(), mode='valid')
            ctx.save_for_backward(input, filter)
            return torch.FloatTensor(result)

        @staticmethod
        def backward(ctx, grad_output):
            input, filter = ctx.saved_tensors
            grad_output = grad_output.data
            grad_input = convolve2d(grad_output.numpy(), filter.t().numpy(), mode='full')
            grad_filter = convolve2d(input.numpy(), grad_output.numpy(), mode='valid')

            return Variable(torch.FloatTensor(grad_input)), \
                Variable(torch.FloatTensor(grad_filter))


    class ScipyConv2d(Module):

        def __init__(self, kh, kw):
            super(ScipyConv2d, self).__init__()
            self.filter = Parameter(torch.randn(kh, kw))

        def forward(self, input):
            return ScipyConv2dFunction.apply(input, self.filter)







**Example usage:**



.. code-block:: python


    module = ScipyConv2d(3, 3)
    print(list(module.parameters()))
    input = Variable(torch.randn(10, 10), requires_grad=True)
    output = module(input)
    print(output)
    output.backward(torch.randn(8, 8))
    print(input.grad)




.. rst-class:: sphx-glr-script-out

 Out::

    [Parameter containing:
    -0.0130  1.2956  0.1126
     0.2135 -0.1948  0.2713
     0.8329 -0.2229 -0.6840
    [torch.FloatTensor of size 3x3]
    ]
    Variable containing:
    -0.4545 -0.6784 -0.3497  0.0143  2.4868 -0.5146 -2.7057  2.7398
    -1.2426 -0.4883 -0.9379  1.0114  1.5793 -2.7874  1.6691  1.0881
    -3.3021  0.4382  2.6584 -0.4628 -2.0121 -0.9175  0.1969  1.9960
     0.1950  1.7578 -0.2701  3.2506 -0.3003  1.0714  1.4350  0.3301
    -0.0445  1.7896 -2.4048 -0.7058  0.5427  1.9141  1.0307 -0.0444
     3.9496 -1.3037  1.0311  0.0832 -2.7702  1.7433  1.6467 -0.5777
    -0.8909 -0.7398 -0.0868  0.5259 -0.7669  0.1229 -1.4596 -0.1612
    -3.1666 -1.9142  2.8550 -1.2741  2.1313  3.0058 -2.0854 -1.3588
    [torch.FloatTensor of size 8x8]

    Variable containing:
    -0.0031  0.0634  0.0164 -0.8762 -0.3654  0.5707  0.9064  0.5659 -1.6957 -0.9779
     0.3174 -1.2691 -0.9207  0.5417  1.1130  1.3187 -5.1117 -1.2303  1.0396  1.0150
    -0.3172 -0.8263 -1.3171  3.3479 -2.0939  0.7415 -0.6938 -0.8640  1.2094  0.1618
    -1.5917  1.6780  1.4187  1.1051 -2.5157 -2.5165  4.5397  0.6987  0.9513  1.7781
    -1.3305  1.2405 -0.1718 -2.6359 -0.9248 -0.8981 -0.0272  2.4336 -3.1280  0.6005
    -0.6821 -3.3565 -1.7923 -2.9415 -0.2876 -1.0246 -2.9142  1.2342  2.6241 -1.3533
    -3.8350  0.3536  0.2814  0.1404  1.5458 -0.6268  2.1790 -0.0419  0.6701 -1.7186
    -0.2320 -1.4082  4.8192 -2.4635 -0.8159 -1.1974 -0.1831 -1.1052 -1.1687 -2.6283
    -0.0874 -1.2564  0.6950  0.5953 -1.1585 -1.9990  0.4133 -2.4274  0.5297  1.2729
    -0.0083 -0.1276 -0.1730  0.7052 -0.2360  0.1567 -0.8495  1.0229 -0.9234  1.8361
    [torch.FloatTensor of size 10x10]


**Total running time of the script:** ( 0 minutes  0.009 seconds)



.. only :: html

 .. container:: sphx-glr-footer


  .. container:: sphx-glr-download

     :download:`Download Python source code: numpy_extensions_tutorial.py <numpy_extensions_tutorial.py>`



  .. container:: sphx-glr-download

     :download:`Download Jupyter notebook: numpy_extensions_tutorial.ipynb <numpy_extensions_tutorial.ipynb>`


.. only:: html

 .. rst-class:: sphx-glr-signature

    `Gallery generated by Sphinx-Gallery <https://sphinx-gallery.readthedocs.io>`_
